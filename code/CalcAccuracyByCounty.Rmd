---
title: "Calculate Accuracy of Merged CDL/NVC Raster"
author: "Melanie Kammerer"
date: "1/11/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Objective
The goal of this script is to map the accuracy of CDL, NVC, and combined rasters. To do this, I use class-level data on spatial accuracy from USDA NASS and LANDFIRE for CDL and NVC, respectively. I combined accuracy statistics from two layers by calculating an area-weighted mean.

```{r loadtabulardata}
library(dplyr); library(logger); library(future); library(terra)
rm(list=ls())
# load accuracy data from LANDFIRE and USDA NASS (aggregated & formatted in 'AggregateAccuracyAssessmentData.Rmd' script)
nvc <- read.csv('./data/LANDFIRE_Accuracy/NVC_Accuracy_allregions.csv')
cdl <- read.csv('./data/CDL_Accuracy/CDL_accuracy_long_allstates_2012to2020.csv')

```
 
## Load pixel frequency by county
I use 2016 as a test year to start.

```{r loadfreq}
county_shp <- sf::st_read('D:/SpatialData/county_boundaries/us_counties_better_coasts.shp')

nvc_county <- read.csv('./data/PixelFreq/NVC_CountyPixelFreq.csv') %>%
  dplyr::filter(!is.na(County)) %>%
  dplyr::group_by(State, County) %>%
  dplyr::mutate(PctCounty = NCells/sum(NCells)) %>%
  dplyr::ungroup()

```


## Why are there counties with >50% NA values in NVC??
```{r testcrop}
national_raster <- raster::raster('D:/SpatialData/LANDFIRE/US_200NVC/Tif/us_200nvc.tif')

one_county <- county_shp %>%
    dplyr::filter(!is.na(COUNTY)) %>% # take out state polygons that are all NA (sections of Great Lakes, for example)
    dplyr::group_by(STATE, COUNTY) %>%
    summarize(geometry=sf::st_combine(geometry)) %>%
    sf::st_transform(crs = sf::st_crs(national_raster))

  counties <- sf::st_read(countypath) %>%
    dplyr::filter(!is.na(COUNTY)) %>% # take out state polygons that are all NA (sections of Great Lakes, for example)
    dplyr::group_by(STATE, COUNTY) %>%
    sf::st_combine()
    sf::st_transform(crs = sf::st_crs(national_raster))
    

onecounty_raster <- raster::crop(national_raster, raster::extent(one_county)) %>%
  raster::mask(one_county)

freq <- raster::freq(onecounty_raster, progress=T, merge=T) %>%
  data.frame() %>%
  dplyr::mutate(State = one_county$STATE, County=one_county$COUNTY) %>%
  dplyr::rename(Class = value, NCells=count)


```

