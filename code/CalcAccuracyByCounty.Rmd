---
title: "Calculate Accuracy of Merged CDL/NVC Raster"
author: "Melanie Kammerer"
date: "1/11/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Objective
The goal of this script is to map the accuracy of CDL, NVC, and combined rasters. To do this, I use class-level data on spatial accuracy from USDA NASS and LANDFIRE for CDL and NVC, respectively. I combined accuracy statistics from two layers by calculating an area-weighted mean.

```{r loadtabulardata}
library(dplyr); library(logger); library(future); library(terra)
rm(list=ls())
# load accuracy data from LANDFIRE and USDA NASS (aggregated & formatted in 'AggregateAccuracyAssessmentData.Rmd' script)
evt <- read.csv('./data/LANDFIRE_Accuracy/EVT_Accuracy_allregions.csv')
nvc <- read.csv('./data/LANDFIRE_Accuracy/NVC_Accuracy_allregions.csv')
cdl <- read.csv('./data/CDL_Accuracy/CDL_accuracy_long_allstates_2012to2020.csv')

# accuracy assessment missing some classes (contingency tables sometimes only have classes with auto-key plots)

all_classes <- read.csv('./data/TabularData/LF_200NVC_05142020.csv')
toadd <- dplyr::filter(all_classes, !VALUE %in% nvc$LANDFIRE_Class) %>%
  dplyr::mutate(ProducerNPlots_autokey=0)

nvc <- dplyr::full_join(nvc, dplyr::select(toadd, VALUE, NVC_Name, ProducerNPlots_autokey), 
                        by=c('LANDFIRE_Class'='VALUE', 
                             'LANDFIRE_Name' ='NVC_Name','ProducerNPlots_autokey'))

length(unique(nvc$LANDFIRE_Class)) == length(unique(nvc$LANDFIRE_Name))

# custom max function that returns NA if both input values are NA
mymax <- function(...,def=NA,na.rm=FALSE) {
    if(!is.infinite(x<-suppressWarnings(max(...,na.rm=na.rm)))) {
      x } else {def}
}

# for NVC classes that were taken from EVT, use the accuracy data from EVT
lf <- dplyr::left_join(nvc, evt, by=c('LANDFIRE_Class', 'LANDFIRE_Name', 'Region'), suffix=c('.nvc', '.evt')) %>%
  dplyr::group_by(LANDFIRE_Class, LANDFIRE_Name, Region) %>%
  dplyr::mutate(ProducerAccuracy = mymax(ProducerAccuracy.nvc, ProducerAccuracy.evt, na.rm=T),
                ProducerNPlots_autokey = mymax(ProducerNPlots_autokey.nvc, ProducerNPlots_autokey.evt, na.rm=T),
                UserAccuracy = if_else(ProducerNPlots_autokey==ProducerNPlots_autokey.nvc, UserAccuracy.nvc, UserAccuracy.evt),
                UserNPlots_map = if_else(ProducerNPlots_autokey==ProducerNPlots_autokey.nvc, UserNPlots_map.nvc, UserNPlots_map.evt)) %>%
  dplyr::ungroup()

# specify classes that COULD have plots in auto-key (are non-managed, not agriculture or NLCD developed)
nvc_agclasses <- c(7960:7999) # classes in LANDFIRE NVC that are agriculture

managed_classes <- lf$LANDFIRE_Class[grepl(lf$LANDFIRE_Name, pattern='Developed-') | 
                                       grepl(lf$LANDFIRE_Name, pattern='Recently Burned-') | 
                                       grepl(lf$LANDFIRE_Name, pattern='Recently Logged-') | 
                                       grepl(lf$LANDFIRE_Name, pattern='Recently Disturbed Other-') | 
                                       lf$LANDFIRE_Class %in% nvc_agclasses |
                                         lf$LANDFIRE_Name == 'Open Water']

# does a particular class have any auto-key plots?
lf$RFBD_Status <- if_else(lf$ProducerNPlots_autokey >= 30, 'well-represented',
                      if_else(lf$ProducerNPlots_autokey < 30 & lf$ProducerNPlots_autokey > 0, 'poorly-represented',
                      if_else(lf$ProducerNPlots_autokey == 0 & lf$LANDFIRE_Class %in% managed_classes, 'absent, managed/ag/disturbed',
                      if_else(lf$ProducerNPlots_autokey == 0 & !lf$LANDFIRE_Class %in% managed_classes, 'absent, could be added', 'uh oh'))))

table(lf$RFBD_Status)

# which un-managed classes are missing from reference DB
sort(unique(lf$LANDFIRE_Name[lf$RFBD_Status == 'absent, could be added']))
```
 
## Load NVC pixel frequency by county

```{r loadfreq}
library(dplyr)
# read county shapefile, remove polygons that are NA for county name (usually sections of water adjacent a state)
county_shp <- sf::st_read('D:/SpatialData/county_boundaries/us_counties_better_coasts.shp') %>%
  dplyr::filter(!is.na(COUNTY))

# add NVC region to county shapefile
# load region shapefile and reproject to match counties
regions <- sf::st_read('./data/SpatialData/LANDFIRE/us_lf_zones/us_lf_zones.shp') %>%
  dplyr::group_by(LF2010_GA) %>%
  summarize(geometry = sf::st_union(geometry)) %>% # original region shapefile had multiple polygons per region, so I dissolve them
  sf::st_transform(crs = sf::st_crs(county_shp)) # project region polygon to match counties

plot(regions)

# convert county polygons to centroids and calculate intersection between regions and county centroids
la <- sf::st_centroid(county_shp) %>% 
  sf::st_join(regions, join=sf::st_intersects) %>%
  dplyr::rename(LF2010_Region=LF2010_GA) %>%
  sf::st_drop_geometry() %>%
  dplyr::select(FIPS, LF2010_Region) %>%
  dplyr::arrange(FIPS)

# add region column to original county shapefile
county <- dplyr::arrange(county_shp, FIPS) %>% cbind(la) %>%
  dplyr::group_by(FIPS, STATE, COUNTY, STATE_FIPS, LF2010_Region) %>%
  summarize(geometry = sf::st_combine(geometry)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(!duplicated(paste0(county$STATE, county$COUNTY)))

plot(county[5])

# read NVC pixel frequency data
nvc_county <- read.csv('./data/PixelFreq/NVC_CountyPixelFreq.csv') %>%
  dplyr::filter(!is.na(County)) %>%
  dplyr::group_by(State, County) %>%
  dplyr::mutate(PctCounty = NCells/sum(NCells)) %>%
  dplyr::ungroup() 

# are there any counties in county shapefile that are NOT in dataset on NVC pixel frequency?
paste0(county$COUNTY, ", ", county$STATE)[!paste0(county$COUNTY, ", ", county$STATE) %in% paste0(nvc_county$County, ", ", nvc_county$State)]

nvc_county <- sf::st_drop_geometry(county) %>%
    dplyr::select(STATE, COUNTY, LF2010_Region) %>%
    dplyr::left_join(nvc_county, by=c('STATE'='State', 'COUNTY'='County'))

# how many classes in spatial data are missing from tabular data?
sort(unique(nvc_county$Class[!nvc_county$Class %in% lf$LANDFIRE_Class]))
```

# Join NVC accuracy metrics with pixel frequency
```{r join}
# join accuracy values
nvc_accuracy <- dplyr::left_join(nvc_county, lf, by=c('Class'='LANDFIRE_Class', 'LF2010_Region'='Region'))

# why are there some counties with NA for NVC value?
View(nvc_accuracy[is.na(nvc_accuracy$Class),])

# proportion non-ag that is well-represented
toplot <- dplyr::group_by(nvc_county, State, County) %>%
  dplyr::filter(!Class %in% managed_classes)
  dplyr::mutate(NCells_NonManaged = sum(NCells)) %>%
  dplyr::filter(Class %in% 1)  





```

