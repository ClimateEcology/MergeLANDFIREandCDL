---
title: "Make Attribute Table for Combined Vegetation Layer"
author: "Melanie Kammerer"
date: "3/16/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F)
```

## Objective

The objective of this script is to generate an attribute table for the combined LANDFIRE vegetation and USDA NASS CDL raster layer.

## Specify which LANDFIRE vegetation map to use (EVT or NVC)
The two (main) options here are Existing Vegetation Type (LANDFIRE 1.0.5) or National Vegetation Classification (2.0).
```{r whichveglayer}
rm(list=ls())
library(dplyr)

veglayer <- 'nvc'
```

## Load tabular data for NASS CDL and LANDFIRE EVT land cover classes
For either EVT or NVC, I specify which column of the data contains the vegetation class name. We will use this later to filter the data.
```{r loadtabular}
#load tabular data for NVC

vegclasses_key <- read.csv('D:/SpatialData/LandFire/US_200NVC/CSV_Data/LF_200NVC_05142020.csv')
name_column <- 'NVC_Name'; name_column <- sym(name_column)


#read CDL class names
cdl_classes <- read.csv('D:/SpatialData/NASS_CDL/NASS_classes.csv') %>% 
  dplyr::filter(VALUE < 500) #filter out CDL classes that I created for a different project
```

## Load combined vegetation map
```{r loadvegmap}
library(terra)
#vegmap <- terra::rast('./data/CombinedVegCDLRasters/MergeCDlandLANDFIRE_v2/NVC_CDL2016.tif')
```

## Create attribute table for combined raster
```{r attributes}

#create new version of CDL class table with negative values to match raster
cdl_tomerge <- dplyr::mutate(cdl_classes, VALUE = -VALUE) %>%
  dplyr::filter(GROUP == 'A'|VALUE %in% c(-176, -61, -37)) %>%
  dplyr::select(VALUE, CLASS_NAME, RED, GREEN, BLUE)

nvc_tomerge <- dplyr::select(vegclasses_key, VALUE, !!name_column, r, g, b, Red, Green, Blue) %>%
  dplyr::filter(!VALUE %in% c(7960:7999)) %>%
  dplyr::rename(RED=Red, GREEN=Green, BLUE=Blue) %>%
  dplyr::select(-r, -g, -b)

#merge CDL attribute table with LANDFIRE
#create 'ID' column so this data frame plays nice with format raster package expects
all_classes <- nvc_tomerge %>%
  dplyr::rename(CLASS_NAME = !!name_column) %>%
  dplyr::full_join(cdl_tomerge, by=c('VALUE', 'CLASS_NAME', 'RED', 'GREEN', 'BLUE')) %>%
  dplyr::rename(Class_Name = CLASS_NAME) %>%
  dplyr::mutate(ID = VALUE) %>%
  dplyr::select(ID, tidyr::everything()) %>%
  dplyr::filter(!duplicated(VALUE)) #take out extra 'background, value = 0' row

# add created class for 'no data, mis-matched pixel'
toadd <- all_classes[1,] %>%
  dplyr::mutate(ID=-1001, VALUE=-1001, Class_Name='Nodata, CDL/NVC mismatch')

all_classes <- rbind(all_classes, toadd)
```
## Save tables
```{r save}
#write attribute table to csv
write.csv(all_classes, './data/TabularData/CombinedRasterAttributeTable_CDLNVC.csv', row.names=F)

```





