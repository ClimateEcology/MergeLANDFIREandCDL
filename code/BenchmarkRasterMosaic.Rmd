---
title: "Benchmark Raster Mosaic"
author: "Melanie Kammerer"
date: "1/12/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r terra_mosaic}
library(terra)

# input parameters
CDLYear <- 2019
tiledir = outdir = 'D:/MergeLANDFIRECDL_Rasters/CTTiles_21/MergedCDLNVC'
chunksize1=40
chunksize2=5
ID <- paste0('CT_CDL', CDLYear,'NVC')

season=NA
compress=T  


  tile_paths <- list.files(tiledir, full.names=T)
  
  # exclude any extra files
  tile_paths <- tile_paths[!grepl(tile_paths, pattern= ".tif.aux")]
  tile_paths <- tile_paths[!grepl(tile_paths, pattern= "MegaTile")]
  tile_paths <- tile_paths[!grepl(tile_paths, pattern= "Final")]

    # filter to correct year of CDL (or other ID variable, as necessary)
  # this ID variable will also be included in filename of final output raster
  
  if (!is.na(ID)) {
    tile_paths <- tile_paths[grepl(tile_paths, pattern=ID)]
  }
  
  tile_list <- vector("list", length(tile_paths))
  
  for (i in 1:length(tile_paths)) {
    tile_list[[i]] <- terra::rast(tile_paths[i])
  }
  
  # end <- length(tile_list)
  # 
  # for (i in 1:ceiling(end/chunksize1)) {
  #   
  #   #  split tile_list, each with x tiles or fewer (x = chunksize1)
  #   if (i == 1 & end < chunksize1) {
  #     assign(x=paste0('args', i), value=tile_list[1:end]) # if there are less than chunksize1 tiles, args 1:max
  #   } else if (i == 1 & end >= chunksize1) {
  #     assign(x=paste0('args', i), value=tile_list[1:(chunksize1*i)]) # if there are more than chunksize1 tiles, args1 = 1:chunksize1
  #   } else if (i > 1 & i < ceiling(end/chunksize1)) {
  #     assign(x=paste0('args', i), value=tile_list[(chunksize1*(i-1)+1):(chunksize1*i)]) # middle args list = end of previous + 1:next increment of chunksize1
  #   } else {
  #     assign(x=paste0('args', i), value=tile_list[(chunksize1*(i-1)+1):end]) # last args list = end of previous + 1:end
  #   }
  #   
  #   # if the last list is only 1 tile, join this tile with the previous mega-tile
  #   if (length(get(paste0('args', i))) < 2) {
  #     assign(x=paste0('args', i-1), value=tile_list[(chunksize1*(i-2)+1):end]) # add orphan tile to the previous list
  #     
  #     # re-do the previous mega-tile to add in the last orphaned tile
  #     assign(x=paste0('MT', i-1), value= base::eval(rlang::call2("mosaic", !!!get(paste0('args', i-1)), .ns="terra", fun='mean',
  #                                                   filename=paste0(tiledir, '/', ID, "_MegaTile", i-1, '.tif'), overwrite=T)))
  #   } else {
  #     
  #     # for the list of chunksize1 or fewer tiles, execute mosaic to create a mega-tile
  #     assign(x=paste0('MT', i), value= base::eval(rlang::call2("mosaic", !!!get(paste0('args', i)), .ns="terra", fun='mean',
  #                                                 filename=paste0(tiledir, '/', ID,"_MegaTile", i, '.tif'), overwrite=T)))
  #   }
  # }
  tictoc::tic()
  base::eval(rlang::call2("mosaic", !!!get('tile_list'), .ns="terra", fun='mean', filename=paste0(tiledir, '/', ID,"_MegaTile_terra.tif"), overwrite=T))
  tictoc::toc()
  
  tictoc::tic()
  gdalUtils::mosaic_rasters(gdalfile=tile_paths, dst_dataset=paste0(tiledir, '/', ID,"_MegaTile_gdal.tif"))
  tictoc::toc()

```